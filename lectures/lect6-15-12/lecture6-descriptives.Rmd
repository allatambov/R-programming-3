---
title: "Основы программирования в R"
subtitle: "Лекция 5. Описательные статистики"
author: "Алла Тамбовцева"
date: '15 декабря 2017 г '
output: html_document
---
## Описательные статистики

Сегодня обсудим интересную базу данных -- базу с экспериментальными данными по шоколадным тортикам (к политологии вернемся на семинаре). 

[Описание базы данных](https://raw.githubusercontent.com/vincentarelbundock/Rdatasets/master/doc/lme4/cake.html). 
[Детали по эксперименту](http://r.789695.n4.nabble.com/New-details-about-Cochran-and-Cox-s-chocolate-cake-data-td4694001.html). 

Загрузим базу данных по ссылке:

```{r}
df <- read.csv("https://raw.githubusercontent.com/vincentarelbundock/Rdatasets/master/csv/lme4/cake.csv")
```

Посмотрим на нее:

```{r}
View(df)
```

Для вывода описательных статистик в R есть специальная функция `summary()`:
```{r}
summary(df)
```

Для количественных переменных эта функция выдает минимальное и максимальное значение, среднее арифметическое, медиану, нижний (1st Qu.) и верхний (3rd Qu.) квартиль. Нижний квартиль -- значение, которое 25% значений в выборке не превышают, а верхний квартиль -- значение, которое 75% значений в выборке не превышают. Для качественных переменных (текстовые, факторные), R будет выводить количество значений по каждой группе (уровню).

В данном случае по выдаче R мы можем определить следующее. Всего в базе данных у нас 270 наблюдений (переменная X здесь служит id наблюдений, а ее максимальное значение 270), значит, в рамках исследования было приготовлено 270 шоколадных тортов. Минимальная температура, при которой выпекали торты, равна 175 градусам, максимальная - 225. Средняя температура, при которой выпекали торты, равна 200. Медианное значение температуры в данном случае совпадает со средним значением -- в половине случаев температура при выпечке не превышала 200 градусов. Нижний квартиль равен 185 градусам -- в 25% случаев торты выпекались при температуре не выше 185 градусов, верхний квартиль равен 215 -- 75% случаев температура не превышала 215 градусов (или в 25% случаев превышала!). 

Необязательно выводить описательные статистики для всех переменных в базе данных, можно вывести описание одной переменной:
```{r}
summary(df$temperature)
```

Или проделать то же самое для нескольких переменных:

```{r}
summary(df[5:6])
```

Или так: 

```{r}
summary(df[ , c("angle", "temperature")])
```

Точно так же необязательно выводить все статистики сразу. Можно запрашивать по отдельности:

```{r}
min(df$angle) # минимум
max(df$angle) # максимум
mean(df$angle) # среднее
median(df$angle) # медиана
```

В данном случае все показатели считаются без проблем, потому что в базе данных все строки полностью заполнены. В прошлый раз было хуже -- вместо среднего значения R выдавал `NA`, так как в переменной были пропущенные значения. Напомню, чтобы решить эту проблему, мы прописывали дополнительный аргумент `na.rm = TRUE`, который говорил R не учитывать пропущенные значения при расчете статистик (из самой базы значения при этом не выкидываются!). 
```{r}
mean(df$angle, na.rm = TRUE) 
```

Это не единственные описательные статистики, которые можно вывести. Часто нас интересует не только среднее (или медианное) значение, а разброс значений относительно этого среднего. Для этого можем посчитать *выборочную дисперсию* или *стандартное отклонение*. 
```{r}
var(df$temperature) # дисперсия
sd(df$temperature) # стандартное отклонение
```
Но сами по себе эти значения не очень информативны -- по ним сложно понять, насколько однородны наши данные (сильно ли они разбросаны относительно среднего значения). Для того, чтобы оценить степень однородности наших данных, нашей выборки, можно воспользоваться таким показателем как *коэффициент вариации*. Коэффициент вариации считается несложно: стандартное отклонение нужно поделить на среднее значение. Обычно значение коэффициента вариации, взятое по модулю, лежит в пределах от 0 до 1, но иногда, если данные очень разнородны (стандартное отклонение большое), оно может быть больше 1. 

**Вопрос:** а когда коэффициент вариации нужно использовать с осторожностью? 

Часто коэффициент вариации выражают в процентах. Давайте напишем код, который будет считать коэффициент вариации в процентах для переменной `angle`. Ваш <s>ход</s> код, маэстро!
```{r}
# код
sd(df$angle) / mean(df$angle) * 100
```

Конечно, перечисленными примерами не ограничивается описание количественных данных. Есть еще процентили, децили и прочее... Чтобы не запутаться, обсуждать их не будем, почитать про их вычисление в R и интерпретацию можно, например, [здесь](https://alstatr.blogspot.ru/2013/06/quartiles-deciles-and-percentiles.html).

Пока мы обсудили только описательные статистики для количественных переменных. А как быть с качественными? Какую информацию по ним можно получить? Число наблюдений, соответствующих каждому значению (классу):

```{r}
table(df$recipe)
```

В прошлый раз мы говорили о том, что для показателей, измеренных в качественной шкале, вычислять среднее или медиану бессмысленно, нужно смотреть на моду. Искать специальную функцию не нужно, достаточно помнить, что мода -- это значение, которое встречается в выборке чаще всего (да, мода может быть не одна).

Кстати, для количественных переменных функция `table()` тоже хорошо работает:

```{r}
table(df$temperature)
```

Прежде чем перейти к более красивым вещам, предлагаю выполнить маленькое задание.

**Задание**

1. При наклоне на какой угол, в среднем, шоколадный торт начинает ломаться? 
2. Найдите коэффициент вариации (в процентах) для переменной `temperature`. Однородны ли значения температуры, при которой выпекали торты?
3. Найдите моду показателя `recipe`. 
4. Найдите первый, второй и третий децили для показателя `temperature`. Проинтерпретируйте.

**Решение**

```{r}
mean(df$angle) #1
sd(df$temperature) / mean(df$temperature) * 100 # 2
table(df$recipe) # 3
quantile(df$temperature, prob = c(0.1, 0.2, 0.3)) # 4

```


## Описательные статистики с dplyr

Обратимся к библиотеке:

```{r, message=FALSE}
library(dplyr)
```

Выведем стандартную таблицу, которую часто можно увидеть в исследованиях в разделе, посвященном описанию данных. В этой таблице будет указано число наблюдений, среднее значение и стандартное отклонение.

```{r}
df %>% summarise(observations = n(), 
                 avg = mean(temperature),
                 sd = sd(temperature)) 

```

Добавим в таблицу коэффициент вариации:
```{r}
df %>% summarise(observations = n(), 
                 avg = mean(temperature),
                 sd = sd(temperature)) %>% mutate(cv = sd / avg) * 100
```

Не очень важная, но полезная деталь: в качестве названий можно использовать и "сложные названия" -- включающие скобки и прочие символы. Но тогда название столбца нужно вводить в кавычках:
```{r}
df %>% summarise(observations = n(), 
                 avg = mean(temperature),
                 sd = sd(temperature)) %>% mutate("cv (in %)" = sd / avg) * 100
```

Можем вывести описательные статистики для групп наблюдений. Сгруппируем наблюдения по рецепту, по которому готовился торт.

```{r}
df %>% group_by(recipe) %>% 
  summarise(observations = n(), 
  avg = mean(temperature),
  sd = sd(temperature))
```

## Выгрузка результатов

R позволяет выгружать не только таблицы с результатами регрессии, но и почти любые таблицы, например, таблицу с описательными статистиками. Единственная проблема: просто так в Word выгрузить ничего не получится, R дружелюбен только по отношению к LaTeX :) Но эту проблему можно решить.

Для начала загрузим библиотеку `stargazer`. Она используется для выгрузки таблиц "во внешний мир".

```{r, eval=FALSE}
install.packages("stargazer")
```
```{r}
library(stargazer)
```

Для того, чтобы вывести таблицу с описательными статистиками, нужно просто набрать `stargazer()` и указать базу данных:
```{r}
stargazer(df) 
```

Для тех, кто умеет работать в LaTeX, все просто -- R выдал теховский код, который можно просто скопировать в tex-файл. Обратите внимание: в начале кода в качестве комментария всегда указывается, есть ли необходимость догружать (указывать в преамбуле) специальные пакеты или нет. В данном случае не нужно.

Тем, кто в LaTeX не работает, легче не стало. Но выход есть. Целых два. 

**Выход 1. ** Stargazer умеет не только выводить код в консоль, но и сохранять результат в отдельный файл. Этот файл может быть теховским файлом (`.tex`), текстовым (`.txt`) и html-файлом (`.html`или `.htm`). Word умеет открывать файлы с расширением `.htm`.  И Libre Office тоже.

```{r, echo=FALSE}
stargazer(df, type = "html", out = "cake_summary.htm") 
```

Даже если редактор документов не хочет открывать файл или делает это странно, не нужно расстраиваться. Html-файлы, как и страницы в Интернете, можно просто окрыть в браузере. И нужную таблицу отскринить.

**Выход 2. ** Воспользоваться онлайн-редактором для LaTeX, скопировать в него код из консоли и скомпилировать симпатичный pdf-файл. Можно зарегистрироваться на сайте [ShareLatex](https://ru.sharelatex.com/), это бесплатно. Затем зайти и нажать *Создать проект* -- *Новый проект*. Когда мы дадим имя проекту, откроется поле для работы. В левой части -- код, в правой части -- pdf-файл. Нужно добавить в преамбулу (часть перед `\begin{document`}) строку `\usepackage[english, russian]{babel}`, чтобы в документе нормально отображалась кириллица. Затем мы можем убрать строку для заголовка (`\maketitle`) и раздела (`\section`) и вставить туда код из консоли:
```{r}
stargazer(df)
```

Нажать *Компилировать*.

Теперь для простоты вернемся к html-файлам и будем приводить таблицу в порядок. Для начала дадим ей заголовок.

```{r}
stargazer(df, type = "html", 
          title = "Summary statistics",
          out = "cake_summary.htm") 
```

Теперь уберем лишние переменные:

```{r}
stargazer(subset(df, select = c("angle", "temperature", "replicate")), 
          type = "html", 
          title = "Summary statistics",
          out = "cake_summary.htm") 
```

Хотим округлить все значения до второго знака после запятой:

```{r}
stargazer(subset(df, select = c("angle", "temperature", "replicate")),
                 type = "html",
                 out = "cake_summary.htm",
                 title = "Summary statistics",
                  digits = 2)
                
```

Хотим добавить комментарий (текст после таблицы):

```{r}
stargazer(subset(df, select = c("angle", "temperature", "replicate")),
                 type = "html",
                 out = "cake_summary.htm",
                 title = "Summary statistics",
                  digits = 2, notes = "Notes:")
```


