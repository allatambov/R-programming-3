---
title: "Семинар 5. Базы данных и dplyr."
author: "Алла Тамбовцева"
date: '15 декабря 2017 г '
output: html_document
---

1.  Загрузите базу данных с расширением `.csv` и сохраните ее как df (не забудьте про кодировку). Посмотрите на нее.

```{r, message=FALSE}
library(dplyr)

el <- read.csv("47130-8314.csv", encoding = "UTF-8")
View(el)
```

2.  Зайдите на [сайт](http://www.cikrf.ru/) Центральной избирательной комиссии, откройте раздел "Информация о выборах и референдумах", найдите нужные выборы. Страница с результатами выглядит так: . Выберите сводную таблицу результатов выборов, посмотрите, как называются строки в таблице. Соотнесите названия строк в таблице на сайте ЦИК и названия столбцов в базе "Голоса". Оставьте в базе данных столбцы с названиями региона, ТИКа (района) и УИКа, а также столбцы, которые позволят посчитать явку и процент голосов за каждого из кандидатов (используя функции dplyr). 

*Нам нужны столбцы kom1, kom2, kom3, X1 (число избирателей), X9, X10 (недействительные и действительные бюллетени) и X19 -- X23 (число голосов за кандидатов)*.

```{r}
el <- el %>% select(kom1, kom2, kom3, X1, X9, X10, X19, X20, X21, X22, X23)
```

3. Переименуте столбцы с X-ами в названии так, чтобы названия переменных были содержательными (total, valid, invalid, и.т.д.).

```{r}
# не будем использовать mutate из dplyr, можно поступить проще - задать вектор названий столбцов, как в матрицах

colnames(el) <- c("region", "tik", "uik", "total", "invalid", "valid",
                  "Zh", "Zug", "Mir", "Pro", "Put")
```

4. Добавьте в базу данных столбец turnout со значениями явки (пока не в процентах, а просто число недействительных и действительных бюллетеней).

```{r}
el <- el %>% mutate(turnout = invalid + valid)
```

5. Агрегируйте данные по регионам: создате базу aggr_reg, в которой хранятся все те же показатели, но суммированные по регионам.

```{r}
aggr_reg  <- el %>% group_by(region) %>%
  summarise(total = sum(total),
            turnout = sum(turnout),
            Zh = sum(Zh),
            Zug = sum(Zug),
            Mir = sum(Mir),
            Pro = sum(Pro),
            Put = sum(Put))
```

6. Создайте в базе aggr_reg показатель turnout_perc, который соответствует явке (в %) по регионам. Создайте в базе aggr_reg переменные, соответствующие проценту голосов, полученных кандидатами в регионах (процент считается от явки).

```{r}
aggr_reg <- aggr_reg %>% 
  mutate(turnout_perc = turnout / total * 100, 
         Zh_perc = Zh / turnout * 100,
         Zug_perc = Zug / turnout * 100,
         Mir_perc = Mir / turnout * 100,
         Pro_perc = Pro / turnout * 100,
         Put_perc = Put / turnout * 100)
```

Давайте заодно удалим первые четыре строки из базы:

```{r}
aggr_reg <- aggr_reg %>% filter(!is.na(total))
```



